---
layout: post
title: 隐马尔科夫模型(HMM)与条件随机场(CRF)笔记
categories: ML 
---

# HMM
HMM是关于时序的概率模型，属于**生成模型**。其描述了由一个隐藏的马尔科夫链生成不可观测的状态序列，再由各个状态生成一个观测序列的过程。

HMM常用于序列标注(分词/POS/NER/SRL/语音识别/...)任务。即给定观测的序列，预测其对应的标记(状态序列)。可以**假设待标注的数据是由隐马尔科夫模型(HMM)生成的，那么我们可通过HMM的学习(确定模型参数)与预测(确定最优隐状态序列)算法进行标注。**



## 数学描述

HMM由初始状态概率分布向量$$\pi$$、状态转移概率分布矩阵$$A$$以及观测概率分布矩阵$$B$$确定。

下面具体描述HMM的三个组成部分。

设$$Q=\left\{ q_1,q_2,\cdots ,q_N \right\}$$是所有可能的状态集合，$$V=\left\{ v_1,v_2,\cdots ,v_M \right\}$$是所有可能的观测值集合，$$N$$是可能的状态数，$$M$$是可能的观测数。$$I=\left( i_1,i_2,\cdots ,i_T \right)$$是长度为$$T$$的状态序列，$$O=\left( o_1,o_2,\cdots ,o_T \right)$$是对应的观测序列。

则


$$\pi =\left[ \pi _i \right] _{1\times N}$$其中$$\pi _i=P\left( i_1=q_i \right) ,i=1,2,\cdots ,N$$表示初始时刻$$t=1$$处于某个状态$$q_i$$的概率。


$$A=\left[ a_{ij} \right] _{N\times N}$$其中$$a_{ij}=P\left( i_{t+1}=q_j\|i_t=q_i \right) ,i=1,2,\cdots ,N;j=1,2,\cdots ,N$$表示在时刻$$t$$处于状态$$q_i$$的条件下，下一时刻$$t+1$$转移到状态$$q_j$$的概率。


$$B=\left[ b_j\left( k \right) \right] _{N\times M}$$其中$$b_j\left( k \right) =P\left( o_t=v_k\|i_t=q_j \right) ,j=1,2,\cdots ,N;k=1,2,\cdots ,M$$表示在时刻$$t$$处于状态$$q_j$$的条件下，观测到$$v_k$$的概率。


**初始状态概率向量$$\pi$$和状态转移概率矩阵$$A$$确定了隐藏的马尔科夫链，生成不可观测的状态序列。观测概率矩阵$$B$$确定了如何从状态序列生成观测序列。** 综上，HMM可由三元符号表示成$$\lambda =\left( A,B,\pi \right) $$。 

**HMM具体的数值例子(例10.1 盒子和球模型)见李航的《统计学习方法》**

## 相关假设
由上述定义可知，HMM有如下假设
1. 齐次马尔科夫性假设。即假设隐藏的马尔科夫链在任意时刻$$t$$的状态只依赖于其前一时刻的状态，与其他时刻的状态及观测无关，也与时刻$$t$$无关。
2. 观测独立性假设。即假设任意时刻的观测只依赖于该时刻的马尔科夫链的状态，与其他观测及状态无关。

## 观测序列的生成
**输入：** 隐马尔可夫模型$$\lambda =\left( A,B,\pi \right)$$，观测序列长度$$T$$

**输出：** 观测序列$$O=\left( o_1,o_2,\cdots ,o_T \right)$$

- (1) 由初始状态概率分布$$\pi$$，确定初始状态$$i_1$$
- (2) 令$$t=1$$
- (3) 由当前状态$$i_t$$的观测概率分布阵$$B$$，确定观测值$$o_t$$
- (4) 由状态转移概率阵$$A$$，确定下一时刻的状态$$i_{t+1}$$
- (5) 令$$t=t+1$$，如果$$t<=T$$，跳到(3);否则终止。
 
## HMM在分词中的应用
假设有文本(观测)序列$$X=x_1,x_2,...,x_n$$，HMM分词的任务就是根据序列$$X$$进行推断，得到标记(状态)序列$$Y=y_1,y_2,...,y_n$$。即计算如下概率，使其值最大：

$$ P\left( y_1,y_2,\cdots ,y_n\|x_1,x_2,\cdots ,x_n \right) $$

由贝叶斯公式可得

$$P\left( y_1,y_2,\cdots ,y_n\|x_1,x_2,\cdots ,x_n \right) =\frac{P\left( y_1,y_2,\cdots ,y_n,x_1,x_2,\cdots ,x_n \right)}{P\left( x_1,x_2,\cdots ,x_n \right)}$$

又序列是确定的，则$$P\left( x_1,x_2,\cdots ,x_n \right) $$为常值。所以**只需使下式值最大**

**$$P\left( x_1,y_1,x_2,y_2,\cdots ,x_n,y_n \right) =P\left( y_1 \right) P\left( x_1\|y_1 \right) \prod_{i=2}^n{P\left( y_i\|y_{i-1} \right) P\left( x_i\|y_i \right)} \qquad   (1)$$**  

而右式中的$$P\left( y_1 \right)$$、$$P\left( y_i\|y_{i-1} \right)$$和$$P\left( x_i\|y_i \right)$$分别是初始状态概率向量$$\pi$$、状态转移概率矩阵$$A$$和观测概率矩阵$$B$$中的元素。当$$\lambda =\left( A,B,\pi \right) $$确定后，可通过维特比算法求出一个文本序列对应概率最大的分词标记序列，最终完成分词任务。

### 参数的确定
假设所给语料的格式如下：
- 文本序列(**字典中共有N个字**)
- 预测序列(**B**egin/**M**iddle/**E**nd/**S**ingle/**O**ther)，分词任务中通常用BMES标记，此时**隐状态个数为4**

语料中的一个样本

- 请问今天南京的天气怎么样
- BEBEBESBEBME

1) 初始状态概率向量
统计每个句子开头的序列标记分别为$$B,S$$的个数，然后除以总句子的个数，即得到了初始概率向量。

2) 状态转移概率矩阵
统计语料中前后序列标记间转移的个数。如统计语料中，在$$t-1$$时刻标记为$$M$$的条件下，$$t$$时刻标记为$$E$$出现的次数，类似的统计可得到4*4的矩阵，再将矩阵的每个元素除以相应行对应标记的总个数，保证行的概率和为1。最终得到状态转移概率矩阵。

3) 观测概率矩阵
统计语料中在某个标记下，某个观测值出现的个数。如统计语料中，在$$t$$时刻标记为$$B$$的条件下，$$t$$时刻观测到字为”南“的次数。类似的统计得到一个4*N的矩阵，再将矩阵的每个元素除以语料中某个标记的总次数，保证行的概率和为1。最终得到观测概率矩阵。

### 维特比算法
由上面三组概率，确定一条**概率最大**的标记序列。即确定的标记序列使得式$$(1)$$的值最大。

基于上述HMM的数学描述，先给出一般的维特比算法流程。

变量$$\delta _t\left( i \right) ,\varPsi _t\left( i \right)$$的定义

**定义**在给定模型参数$$\lambda$$条件下，$$t$$时刻状态为$$i$$时，所有可能的标注序列$$(i_1,i_2,...,i_t)$$中，概率最大值记为

$$\delta _t\left( i \right) =\underset{i_1,i_2,\cdots ,i_{t-1}}{\max}P\left( i_t=i,i_{t-1},\cdots ,i_1,o_t,\cdots ,o_1\|\lambda \right) ,i=1,2,\cdots ,N$$

则$$\delta _{t+1}\left( i \right) =\underset{i_1,i_2,\cdots ,i_t}{\max}P\left( i_{t+1}=i,i_t,\cdots ,i_1,o_{t+1},\cdots ,o_1\|\lambda \right) $$

**又当$$t+1$$时刻标注序列状态$$i_{t+1}$$确定时，则$$t+1$$时刻的观测概率$$P\left( o_{t+1}\|i_{t+1} \right)$$也是确定的(观测序列已知)。** 因此由式$$(1)$$的联合概率公式，$$\delta _{t+1}\left( i \right)$$可进一步写成

$$\delta _{t+1}\left( i \right) =\underset{1\le j\le N}{\max}\left[ \delta _t\left( j \right) a_{ji} \right] b_i\left( o_{t+1} \right) ,i=1,2,\cdots ,N;t=1,2,\cdots ,T-1$$

**定义**在$$t$$时刻状态为$$i$$时，所有可能的标注序列$$(i_1,i_2,...,i_t)$$中，概率最大值时对应的$$t-1$$时刻(前一时刻)的**标注序列**为

$$\varPsi _t\left( i \right) =\underset{1\le j\le N}{arg\max}\left[ \delta _{t-1}\left( j \right) a_{ji} \right] $$

基于上述两个变量的定义，**维特比算法的流程**如下：

**输入：** 模型$$\lambda =\left( A,B,\pi \right)$$和观测序列$$O=\left( o_1,o_2,\cdots ,o_T \right)$$

**输出：** 最优标注(状态)序列$$I^*=\left( i_{1}^{*},i_{2}^{*},\cdots ,i_{T}^{*} \right) $$

(1) 初始化$$t=1$$:

$$\delta _1\left( i \right) =\pi _ib_i\left( o_1 \right) ,\varPsi _1\left( i \right) =0,i=1,2,\cdots ,N$$

(2) 递推

$$\delta _t\left( i \right) =\underset{1\le j\le N}{\max}\left[ \delta _{t-1}\left( j \right) a_{ji} \right] b_i\left( o_t \right) ,i=1,2,\cdots ,N$$，其中$$t=2,3,\cdots,T$$


$$\varPsi _t\left( i \right) =\underset{1\le j\le N}{arg\max}\left[ \delta _{t-1}\left( j \right) a_{ji} \right] ,i=1,2,\cdots ,N$$

(3) 终止(确定最后时刻$$T$$所有可能的标注序列中概率最大时最后一个位置的标记)

$$i_{T}^{*}=\underset{1\le i\le N}{arg\max}\left[ \delta _T\left( i \right) \right] $$

(4) 回溯 (从后往前确定一个最优标注序列)

$$i_{t}^{*}=\varPsi _{t+1}\left( i_{t+1}^{*} \right) ,t=T-1,T-2,\cdots ,1$$

通过上述一去一回的迭代，最终可得最优标注序列。**具体数值例子(例10.3)见李航的《统计学习方法》**

基于上述描述，具体看一个简单的分词实战。假设给定文本：我爱中国。序列标注有$$BMES$$四种状态。在确定标注序列时，每个字有4种可能的标注状态。如图所示

![png](/assets/images/ml/hmm_crf/hmm-01.png)

(1)初始化

$$
\delta _1\left( B \right) =P\left( x_1=\text{我,}y_1=B \right) =P\left( y_1=B \right) \times P\left( x_1=\text{我|}y_1=B \right) 
$$

$$
\delta _1\left( M \right) =P\left( x_1=\text{我,}y_1=M \right) =P\left( y_1=M \right) \times P\left( x_1=\text{我|}y_1=M \right) 
$$

$$
\delta _1\left( E \right) =P\left( x_1=\text{我,}y_1=E \right) =P\left( y_1=E \right) \times P\left( x_1=\text{我|}y_1=E \right) 
$$

$$
\delta _1\left( S \right) =P\left( x_1=\text{我,}y_1=S \right) =P\left( y_1=S \right) \times P\left( x_1=\text{我|}y_1=S \right) 
$$

$$
\varPsi _1\left( B \right) =\varPsi _1\left( M \right) =\varPsi _1\left( E \right) =\varPsi _1\left( S \right) =UNK
$$

(2) 递推

**$$
\varPsi _2\left( B \right) =\underset{BMES}{arg\max}\left\{ \delta _1\left( B \right) \times P\left( y_2=B|y_1=B \right) ,\delta _1\left( M \right) \times P\left( y_2=B|y_1=M \right) \\, \delta _1\left( E \right) \times P\left( y_2=B|y_1=E \right) ,\delta _1\left( S \right) \times P\left( y_2=B|y_1=S \right) \right\} 
$$**


**$$
\delta _2\left( B \right) =P\left( x_1=\text{我,}y_1=\varPsi _2\left( B \right),x_2=\text{爱,}y_2=B \right) \\=\max \left\{ \delta _1\left( B \right) \times P\left( y_2=B|y_1=B \right) ,\delta _1\left( M \right) \times P\left( y_2=B|y_1=M \right) \\ ,\delta _1\left( E \right) \times P\left( y_2=B|y_1=E \right) ,\delta _1\left( S \right) \times P\left( y_2=B|y_1=S \right) \right\} \times P\left( x_2=\text{爱|}y_2=B \right) 
$$**


**$$
\varPsi _2\left( M \right) =\underset{BMES}{arg\max}\left\{ \delta _1\left( B \right) \times P\left( y_2=M|y_1=B \right) ,\delta _1\left( M \right) \times P\left( y_2=M|y_1=M \right) \\, \delta _1\left( E \right) \times P\left( y_2=M|y_1=E \right) ,\delta _1\left( S \right) \times P\left( y_2=M|y_1=S \right) \right\} 
$$**


**$$
\delta _2\left( M \right) =P\left( x_1=\text{我,}y_1=\varPsi _2\left( M \right),x_2=\text{爱,}y_2=M \right) 
$$**

$$
\vdots 
$$
$$
\ \delta _4\left( B \right) =P\left( x_1=\text{我,}y_1=\varPsi _2\left( B \right) ,x_2=\text{爱,}y_2=\varPsi _3\left( B \right) ,x_3=\text{中,}y_3=\varPsi _4\left( B \right) ,x_4=\text{国,}y_4=B \right) 
$$
$$
\ \delta _4\left( M \right)=P\left( x_1=\text{我,}y_1=\varPsi _2\left( M \right) ,x_2=\text{爱,}y_2=\varPsi _3\left( M \right) ,x_3=\text{中,}y_3=\varPsi _4\left( M \right) ,x_4=\text{国,}y_4=M \right) 
$$
$$
\ \delta _4\left( E \right) =P\left( x_1=\text{我,}y_1=\varPsi _2\left( E \right) ,x_2=\text{爱,}y_2=\varPsi _3\left( E \right) ,x_3=\text{中,}y_3=\varPsi _4\left( E \right) ,x_4=\text{国,}y_4=E \right) 
$$
$$
\ \delta _4\left( S \right) =P\left( x_1=\text{我,}y_1=\varPsi _2\left( S \right) ,x_2=\text{爱,}y_2=\varPsi _3\left( S \right) ,x_3=\text{中,}y_3=\varPsi _4\left( S \right) ,x_4=\text{国,}y_4=S \right) 
$$

(3)终止，确定最后一个位置的标记

$$i_{4}^{*}=\underset{BMES}{arg\max}\left\{ \max \left\{ \delta _4\left( B \right) ,\delta _4\left( M \right) ,\delta _4\left( E \right) ,\delta _4\left( S \right) \right\} \right\} =E$$

(4)回溯，确定最终的标注序列

$$
i_{t}^{*}=\varPsi _{t+1}\left( i_{t+1}^{*} \right) ,t=3,2,1
$$

最终可得序列$$S-S-B-E$$

 
# CRF
 

 